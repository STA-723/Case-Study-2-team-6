---
title: 'Case study 2: New York Airbnb listings'
author:
- name: Olivier Binette, Brian Kundinger and Justin Weltz
date: "January 23, 2020"
output:
  pdf_document:
    citation_package: natbib
    fig_caption: yes
    keep_tex: yes
    latex_engine: pdflatex
    template: svm-latex-ms.tex
  html_document:
    df_print: paged
header-includes: \usepackage{hyperref}
linestretch: 1
link-citations: yes
linkcolor: blue
fontfamily: mathpazo
fontsize: 10pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(tidyverse)
library(cowplot)
library(BAS)
source("prettyplot.R")
library(RColorBrewer)
library(ggmap)
```

```{r, include=FALSE}
data <- readRDS("data_transformed.rds")
```

# 1. Introduction


# 2. Materials and methods

## 2.1 Data

The \texttt{Airbnb} dataset contains data on $48\,895$ listings from New York City which have been active before July 8, 2019. Information is given on the name of the listing, the name of of the host, the type of room available (entire home, private room or shared room), on the minimum number of nights for a rental, on the yearly availability, on the location of the listing (coordinates and neighborhood), on its price, on the number of reviews, and on the average number of reviews per months. 

We note that $35\%$ of the listings are recorded as having zero availability for booking. It is unclear in these cases if the listing is fully booked, or if it is simply no longer available for booking and has been temporarily disabled. Furthermore, the listed availability may have changed throughout time, and we are only provided with its value at the time when the data was collected. We do not use this variable in our analyses given these challenges in interpretability, 

## 2.2 Data cleaning and transformations

Among the listings requiring stays of longer lengths of time, it was often unclear whether the price listed was a monthly, weekly, or daily price. We focus our analysis on listings which can be rented for less than 7 nights. Additionally, listings which had recieved no reviews had relatively high prices in comparison with the rest of the data set. Since listings that had recieved no reviews were not representative of the active listings, we removed these listings from our analysis. Lastly, we remove 11 listings that are priced at more than five thousands dollars a night. Many of these were event spaces or film and photography venues, and thus were not representative of typical Airbnb listing. We thus conducting our analysis with 32819 data points representing typical listings which can be rented for a few nights at a non-extravagant price.

As a measure of popularity, we consider a normalized average number of review per months. Indeed, it appears that the average number of review per months has been computed including the months a listing has been inactive. We have therefore renormalized the average by removing on the denominator the number of months since the last time a listing received a review.

## 2.3 Computed features

The Airbnb dataset was augmented with the following features:

**1. Text analysis.** $\;$ We extracted all adjectives from the listing names and kept those with a frequency of at least 10. We then ran a linear regression of average reviews against these words, and identified all words with p-values below the Bonferonni adjustment of $\frac{0.05}{218}$. This left 18 words for further analysis, and the data has been augmented to contain indicators of the presence or absence of each of these words.

Of important note, some of the words picked up by our algorithms are most likely not adjectives in the context of this dataset. For example, "apt" is most likely a shortening of "apartment," and not an adjective meaning "correct," and minute is most likely a measurement of time and proximity, and not an adjective meaning "small." We choose however to retain these words for the purpose of this analysis.

**2. Distances to subway stations.** $\;$ We computed distance between listings and the nearest subway entrance using data from [New York's Open Data portal](https://data.cityofnewyork.us/Transportation/Subway-Entrances/drex-xx56).

**3. Gender imputation.** $\;$ We imputed hosts gender using data in the R package \texttt{genderdata} through the interface package \texttt{gender}. Host names were compared with records from the U.S. Social Security Administration, and imputation was made when there was more than $90\%$ match to a given gender. Otherwise, such as when the host name consisted of a pair of person, an "Unknown" gender was recorded.


## 2.4 Conditional autoregressive model to assess neighborhood effect on popularity

In order to advise a new Airbnb owner on the best neighborhood to set up a property, we have to be careful to separate the neighborhood effect on popularity from auto-correlation over the spatial dimension. For example, figure 1 and 2 demonstate two density patterns that would make an analysis of neighborhood popularity without controlling for distance problematic. The Theater District in New York City includes Times Square and many other major tourist attractions. In figure 1, we can see that most of the Airbnb locations in Hell's Kitchen are concentrated next to the Theater Disctrict, meaning that the measured effect on popularity of being in the latter nieghborhood may be inflated because it is highly correlated with the desirability of the theater district. Figure 2, depicts another interesting density pattern. We can see that although there are many Airbnb locations on the outskirts of Chinatown, there are very few in the heart of the neighborhood. This could cause Chinatown's popularity coefficient to be closely correlated with the neighborhoods that surround it. If we observe high popularity in this neighborhood and then advise a new Airbnb owner with this information, they could make a large strategic blunder by placing their property in middle of the neighborhood. This seems problematic!

Therefore, we will account for the density of Airbnb locations so that we can measure the "name brand effect" of neighborhoods on popularity. In order to control for the distance between properties, we will use the conditionally auto-regressive model proposed by Lareaux et al. in "Estimation of Disease Rates in Small Areas: A New Mixed Model for Spatial Dependence." This Bayesian approach models spatial auto-correlation as a smooth function of distance using an adjacency matrix and a series of priors on distance effects specified below:

$$\phi_k| \phi_{-k}, W, \tau^2, \rho \sim N(\frac{\rho\sum_{i=1}^k w_{ki}\phi_i}{\rho\sum_{i=1}^k w_{ki} + 1-\rho}, \frac{\tau^2}{\rho\sum_{i=1}^k w_{ki} + 1-\rho})$$

$$\tau^2 \sim Inverse-Gamma(a,b)$$
$$\rho \sim Uniform(0,1)$$

We deternmine the distance between neighbours so that every property has a neighbor and the mean number of neighbours is around 30. The correlation between neighbor's spatial effects is determined by the equation below, where $\rho$ is a global parameter that determines the smoothing of the auto-correlation function (aka the magnitude and decay of correlation between neighboring properties). 

$$CAR(\phi_k, \phi_j | \phi_{-kj}, W, \rho) = \frac{\rho w_{kj}}{\sqrt{(\rho \sum_{i=1}^k w_{ki} + 1 - \rho)(\rho \sum_{i=1}^k w_{ki} + 1 - \rho }}$$

Unfortunately, since the CAR model take a very long time to run on large datasets, we weren't able to model this spatial relationship for every observation and ended up running seperate analyses on each of the boroughs with 1000 randomly selected observations (in each borough). Lastly, we also controlled for price and distance to subway when measuring neighborhood effects in this model.

# CAR Results

Figure 3, which depicts the $\rho$ parameter for each borough, clearly indicates that spatial auto-correlation is present in the dataset even after accounting for neighborhood effects. Even though figures 4-7 indicated a lot of diversity in effects and effect sizes based on neighborhoods, there are only a few coefficients whose $95\%$ posterior credible intervals do not include zero. Only Schuresville and Eastchester in the Bronx (figure 4) and Jamaica Hills and East Elmhurst in Queens (figure 6) have a "significant" effect. Since Queens has the highest popularity intercept and East Elmhurt has a significant positive effect on top of this baseline, it seems like this is the best location for a new Airbnb owner to locate his property! However, overwhelming, the effect of neighbourhoods controlling for distance seems to be negligible. This finding may be the result of NYC's highly interconnected and effecient transit system, which enables visitors to travel to major destinations with ease regardless of their starting point.


# Hierarchical model

```{r}
require(car)
require(lme4)
#install.packages("car")
model_heir <- lmer(nrml_avg_reviews~ (1|neighbourhood_group/neighbourhood)+price +dist_to_subway, data = data)
#summary(model_heir)
#anova(model_heir)
#coef(model_heir)
```

## 2.6 Global hierarchical model to compare effects of different features

We compare the effect of the different given and computed features of the dataset using a log-linear regression. With the log of our normalized monthly number of reviews as a popularity response, we focus on the effects of host gender, of log distance to subway station, of room type, listing price, on the minimum number of nights required, and on the presence of five keywords, while controlling for neighborhood effects. 

The log-linear regression framework allows to obtain easily interpretable estimates of linear trends, while having some robustness to model misspecification. In our case, misspecification stems from the presence of non-linear associations and from a misspecified error model.

```{r}
library(MASS)
data = data %>% filter(price != 0)

model.full = lm(log(nrml_avg_reviews) ~ log(price) + log(dist_to_subway) + months_active + room_type + gender + private + square + minute + close + stock + apt + sunny + spacious + deluxe + newly + walking + cozy + central + fast + huge + west + green + neighbourhood, data=data)
```

```{r}
library(car)

bx = boxTidwell(log(nrml_avg_reviews) ~ price + dist_to_subway + months_active, 
           other.x= ~ room_type + gender + 
             private + square + minute + close + stock + apt + 
             sunny + spacious + deluxe + newly + walking + cozy + 
             central + fast + huge + west + green + neighbourhood, 
           data=data, max.iter=5, tol=0.01)

```

```{r}
bx_fun <- Vectorize(function(x, lambda) {
  return((x^(lambda)-1)/lambda)
})

model.bx = lm(log(nrml_avg_reviews) ~ bx_fun(price, 0.57422) + bx_fun(dist_to_subway, 0.83087) + bx_fun(months_active, -0.27567) + room_type + gender + private + square + minute + close + stock + apt + sunny + spacious + deluxe + newly + walking + cozy + central + fast + huge + west + green + neighbourhood, data=data)

```

```{r}
# Multiplicative effects as a function of quantiles
plot_coef <- function(model, name, values, col=1, add=FALSE, ...) {
  coef_est = c(coef(model)[name], confint(model)[name,])

  coef_effect <- Vectorize(function(q) {
    c(exp(coef_est[1]*quantile(values, q))/exp(coef_est[1]*quantile(values, 0.5)),
      exp(coef_est[2]*quantile(values, q))/exp(coef_est[2]*quantile(values, 0.5)),
      exp(coef_est[3]*quantile(values, q))/exp(coef_est[3]*quantile(values, 0.5)))
  })
  
  q = seq(0,0.99,length.out = 200)
  coef_curve = coef_effect(q)
  
  if(add == FALSE) {
    fun=plot
  } else {
    fun=lines
  }
  
  fun(q, coef_curve[1,], type="l", lwd=2, col=col,
      xlab="Quantile",
     ylab="Multiplicative effect compared to median",
     ...)
  polygon(c(q, rev(q)), c(coef_curve[2,], rev(coef_curve[3,])), border=NA, 
        col=adjustcolor(cmap.knitr(col), alpha.f=0.2))
}
```

```{r}
plot_coef(model.full, "log(price)", log(data$price), ylim=c(0.75,1.25))
plot_coef(model.full, "log(dist_to_subway)", log(data$dist_to_subway), 
          add=T, col=2)
plot_coef(model.full, "months_active", data$months_active, 
          add=T, col=3)

legend("topright", legend=c("log(price)", "log(dist_to_subway)"), lty=c(1,1),
       col=c(cmap.knitr(1), cmap.knitr(2)), cex=0.8)
```

```{r}
plot_coef(model.bx, "bx_fun(price, 0.57422)", bx_fun(data$price, 0.57422), ylim=c(0.8,1.6))
plot_coef(model.bx, "bx_fun(dist_to_subway, 0.83087)", bx_fun(data$dist_to_subway, 0.83087), 
          add=T, col=2)
plot_coef(model.bx, "bx_fun(months_active, -0.27567)", 
          bx_fun(data$months_active, -0.27567), 
          add=T, col=3)

abline(h=1, col=cmap.knitr(0), lty=2)

legend("topright", legend=c("price", "dist_to_subway", "months_active"), lty=c(1,1,1),
       col=c(cmap.knitr(1), cmap.knitr(2), cmap.knitr(3)), cex=0.8)
```


- Keyword importance
    - Take the 5 most important ones to feed in the RF.

- Global hierarchical model

- With all variables (excepted distance)


# 3. Results

- Graphical display of the results

- OB can help with the graphical display


# 4. Discussion


# Appendix

## Proportion of Never Reviewed Listings by Price Decile 

```{r, echo=FALSE, warning=FALSE, fig.height=5}
raw_data <- read.csv("AB_NYC_2019.csv")
  
raw_data %>%
  mutate(quantile = ntile(price, 10)) %>%
  mutate(no_stay = number_of_reviews==0) %>% 
  group_by(quantile) %>%
  count(no_stay == 1)%>% 
  rename(Never_reviewed = `no_stay == 1`) %>% 
  mutate(prop = prop.table(n))%>% 
  ggplot(aes(x = quantile, y = prop, fill = Never_reviewed)) + geom_bar(stat = 'identity', position = 'dodge', alpha = 2/3) + geom_hline(yintercept = mean(raw_data$number_of_reviews == 0)) + ggtitle("Proportion of Never Reviewed by \n Price Decile")+ xlab("Price Decile") + ylab("Proportion")+theme(plot.title = element_text(hjust = 0.5))
```

## Normalized Average Reviews Formula

$$\frac{\text{Days between July 8, 2019 and Last Review}}{30.42} = \text{Months Inactive} $$
$$\frac{\text{No. of Reviews}}{\text{Months Active + Months Inactive}} = \text{Reviews per Month}$$
$$\text{Months Active} = \frac{\text{No. of Reviews - Avg Reviews*Months Inactive}}{\text{Reviews per Month}}$$
$$\text{Normalized Average Reviews} = \frac{\text{Total Reviews}}{\text{Months Active}}$$


## Spatial Auto-correlation and CAR Model

```{r, warning=FALSE, message=FALSE, echo=FALSE, fig.cap= "Theater District"}
data <- readRDS("data_transformed.rds")
data %>% filter( neighbourhood == "Theater District" |neighbourhood == "Hell's Kitchen") %>% ggplot(aes(x  = latitude, y = longitude, color = neighbourhood)) + stat_density2d() + theme(legend.position = "none") + ggtitle("Hell's Kitchen and Theater District Density")


```

```{r, warning=FALSE, message=FALSE, echo=FALSE, fig.cap= "Chinatown"}

data %>% filter(neighbourhood == "Chinatown") %>% ggplot(aes(x  = latitude, y = longitude)) + stat_density2d() + theme(legend.position = "none") + ggtitle("Chinatown Density")

```


## CAR Model Results

```{r, warning=FALSE, message=FALSE, echo= FALSE, fig.cap="Rho Coefficients"}

data_r <- rbind(c("rho", 0.9072, "Bronx"), c("rho", 0.9277, "Manhattan"),  c("rho", 0.7474, "Queens"), c("rho", 0.7389, "Brooklyn"))
data_r <- data.frame(data_r)
names(data_r) <- c("Variables", "Value", "Borough")
data_r  %>% ggplot(aes(x=Borough,y=Value)) + geom_bar(stat="identity") + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + ggtitle("Rho Coefficients")

```


```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Bronx"}

data <- readRDS("Coefficient_Data.rds")

data%>% filter(Variables != "(Intercept)" & Variables != "price" & Variables != "dist_to_subway") %>% filter(Borough == "Bronx") %>% ggplot(aes(x=Variables,y=Value)) + geom_bar(stat="identity") + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + ggtitle("Bronx Coefficients (Reference: Allerton)")

```


```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.cap= "Manhattan"}

data%>% filter(Variables != "(Intercept)" & Variables != "price" & Variables != "dist_to_subway") %>% filter(Borough == "Manhattan") %>% ggplot(aes(x=Variables,y=Value)) + geom_bar(stat="identity") + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + ggtitle("Manhattan Coefficients (Reference: Battery Park City)")
```


```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Queens"}

data%>% filter(Variables != "(Intercept)" & Variables != "price" & Variables != "dist_to_subway") %>% filter(Borough == "Queens") %>% ggplot(aes(x=Variables,y=Value)) + geom_bar(stat="identity") + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + ggtitle("Queens Coefficients (Reference: Arverne)")
```


```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.cap= "Brooklyn"}

data%>% filter(Variables != "(Intercept)" & Variables != "price" & Variables != "dist_to_subway") %>% filter(Borough == "Brooklyn") %>% ggplot(aes(x=Variables,y=Value)) + geom_bar(stat="identity") + theme(axis.text.x = element_text(angle = 90, hjust = 1))+ ggtitle("Brooklyn Coefficients (Referene: Bath Beach)")
data <-readRDS("data_transformed.rds")
```

## EDA

We first look at a map of the airbnb listings over New York.

```{r, message=FALSE, echo=FALSE, warning=FALSE, cache=TRUE}
register_google(key="AIzaSyDnqUXoVEle0J7gGGZQcdV5HQeQEGRlxLQ")

map_coarse = get_stamenmap(c(left=-74.25, right=-73.5, bottom=40.49, top=41), 
              zoom=10,
              maptype="terrain-background",
              #maptype="toner-background",
              color="bw", force=TRUE)
```

```{r, fig.width=3, fig.height=3, fig.align="center"}
ggmap(map_coarse) +
  geom_point(data=data, aes(x=longitude, y=latitude), 
             size=0.1, alpha=0.5,
             color="black") +
  stat_density2d(data=data, aes(x=longitude, y=latitude,
                                fill=..level.., alpha=..level..), 
                 geom="polygon") +
  guides(alpha = FALSE, fill=FALSE) +
  scale_fill_gradient((brewer.pal(7, "Spectral"))) +
  xlim(-74.15, -73.7) +
  ylim(40.55, 40.91) +
  theme_void()
```

## Neighborhood concentration

```{r, fig.width=3, fig.height=3, fig.align="center"}
data %>% ggplot(aes(x=nrml_avg_reviews, color=gender)) +
  geom_density() +
  theme_minimal()
```


```{r, fig.width=3, fig.height=3, fig.align="center"}
ggplot() +
  geom_hex(data=data, aes(x=longitude, y=latitude, fill=price))+
  xlim(-74.2, -73.65) +
  ylim(40.5, 40.95) +
  theme_void()
```
